<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PixAI â€” Your AI Startup Mentor</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,600;0,700;1,400;1,600;1,700&family=Outfit:wght@300;400;500;600&family=Playfair+Display:ital,wght@1,700;1,800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:#0a0b0f;}
body{color:rgba(255,255,255,.88);font-family:'Outfit',sans-serif;font-size:15px;line-height:1.7;overflow:hidden;}
@keyframes up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes cur{0%,100%{opacity:1}50%{opacity:0}}
@keyframes dotbounce{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-5px);opacity:1}}
@keyframes fadeStatus{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes sideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.06);border-radius:3px}
textarea::-webkit-scrollbar{width:0}
.session-item:hover .session-actions{opacity:1!important}
button{font-family:'Outfit',sans-serif;}
.starter-btn{padding:.4rem .95rem;background:#0f1116;border:1px solid rgba(255,255,255,.07);border-radius:100px;font-size:.77rem;color:rgba(255,255,255,.36);cursor:pointer;transition:all .16s;white-space:nowrap;}
.starter-btn:hover{border-color:rgba(0,194,255,.28);color:rgba(255,255,255,.82);background:rgba(0,194,255,.05);}
.chip-btn{padding:.28rem .82rem;background:rgba(0,194,255,.05);border:1px solid rgba(0,194,255,.16);border-radius:100px;font-size:.74rem;color:rgba(0,194,255,.65);cursor:pointer;transition:all .16s;white-space:nowrap;}
.chip-btn:hover{background:rgba(0,194,255,.12);color:#00c2ff;border-color:rgba(0,194,255,.38);}
@media(max-width:768px){
  .hide-mobile{display:none!important}
  #sidebar{position:fixed!important;top:54px!important;left:0!important;bottom:0!important;z-index:20!important;}
}
</style>
</head>
<body>

<!-- â”€â”€ Loading Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loading-screen" style="position:fixed;inset:0;background:#0a0b0f;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;">
  <span style="font-family:'Cinzel',serif;font-size:1.8rem;font-weight:600;letter-spacing:.22em;background:linear-gradient(180deg,#fff 0%,#a8d8f0 40%,#5bb8e8 70%,#a0d4f5 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:1rem;">PixAI</span>
  <div style="display:flex;gap:6px;">
    <span style="width:6px;height:6px;border-radius:50%;background:rgba(0,194,255,.5);animation:dotbounce 1.4s ease-in-out 0s infinite;display:inline-block;"></span>
    <span style="width:6px;height:6px;border-radius:50%;background:rgba(0,194,255,.5);animation:dotbounce 1.4s ease-in-out .18s infinite;display:inline-block;"></span>
    <span style="width:6px;height:6px;border-radius:50%;background:rgba(0,194,255,.5);animation:dotbounce 1.4s ease-in-out .36s infinite;display:inline-block;"></span>
  </div>
</div>

<!-- â”€â”€ Limit Reached Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="limit-screen" style="display:none;position:fixed;inset:0;background:rgba(10,11,15,.97);z-index:50;align-items:center;justify-content:center;backdrop-filter:blur(12px);">
  <div style="max-width:420px;width:90%;text-align:center;padding:2.5rem;background:#0f1116;border:1px solid rgba(0,194,255,.15);border-radius:24px;box-shadow:0 0 60px rgba(0,194,255,.06);">
    <div style="width:60px;height:60px;border-radius:18px;background:rgba(0,194,255,.08);border:1px solid rgba(0,194,255,.2);display:flex;align-items:center;justify-content:center;margin:0 auto 1.4rem;">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="rgba(0,194,255,.7)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
    </div>
    <h2 style="font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:700;color:rgba(255,255,255,.92);margin-bottom:.6rem;line-height:1.2;">Your Free Trial<br/>Has Been Completed</h2>
    <p style="font-size:.88rem;color:rgba(255,255,255,.38);line-height:1.8;margin-bottom:.5rem;">You've used all <strong style="color:rgba(255,255,255,.6);">30 free messages</strong> for today.</p>
    <p style="font-size:.88rem;color:rgba(255,255,255,.38);line-height:1.8;margin-bottom:1.8rem;">Want to explore your ideas more?<br/><strong style="color:rgba(255,255,255,.6);">Just pick up a starter.</strong></p>

    <!-- Countdown -->
    <div style="background:rgba(0,194,255,.04);border:1px solid rgba(0,194,255,.1);border-radius:12px;padding:.8rem 1.2rem;margin-bottom:1.8rem;">
      <p style="font-size:.62rem;letter-spacing:.15em;text-transform:uppercase;color:rgba(0,194,255,.45);margin-bottom:.3rem;">Free messages reset in</p>
      <p id="countdown-timer" style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:700;color:#00c2ff;letter-spacing:.06em;">00:00:00</p>
    </div>

    <!-- Starter Plan -->
    <div style="background:linear-gradient(135deg,rgba(0,194,255,.08),rgba(79,140,255,.05));border:1px solid rgba(0,194,255,.25);border-radius:16px;padding:1.4rem;margin-bottom:1rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem;">
        <div>
          <p style="font-size:.6rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(0,194,255,.5);margin-bottom:.2rem;">Starter Plan</p>
          <p style="font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:#fff;line-height:1;">$29<span style="font-size:.9rem;color:rgba(255,255,255,.4);font-family:'Outfit',sans-serif;font-weight:300;">/mo</span></p>
        </div>
        <div style="text-align:right;">
          <p style="font-size:.75rem;color:rgba(255,255,255,.5);margin-bottom:.18rem;">âœ“ Unlimited messages</p>
          <p style="font-size:.75rem;color:rgba(255,255,255,.5);margin-bottom:.18rem;">âœ“ Full AI insights</p>
          <p style="font-size:.75rem;color:rgba(255,255,255,.5);">âœ“ Priority support</p>
        </div>
      </div>
      <button id="upgrade-btn" style="width:100%;padding:.78rem;background:linear-gradient(135deg,rgba(0,194,255,.2),rgba(79,140,255,.12));border:1px solid rgba(0,194,255,.4);border-radius:12px;font-size:.9rem;color:#fff;cursor:pointer;font-weight:500;letter-spacing:.04em;transition:all .2s;">
        Get Starter â€” $29/mo
      </button>
    </div>

    <button id="close-limit-btn" style="background:none;border:none;font-size:.75rem;color:rgba(255,255,255,.2);cursor:pointer;letter-spacing:.04em;">
      I'll wait until midnight â†’
    </button>
  </div>
</div>

<!-- â”€â”€ Sidebar backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="sidebar-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:19;backdrop-filter:blur(2px);"></div>

<!-- â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app" style="background:#0a0b0f;height:100vh;display:flex;flex-direction:column;overflow:hidden;">

  <!-- Header -->
  <header style="flex-shrink:0;height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 1.1rem 0 .9rem;border-bottom:1px solid rgba(255,255,255,.055);background:rgba(10,11,15,.97);backdrop-filter:blur(20px);z-index:10;">
    <div style="display:flex;align-items:center;gap:.6rem;">
      <button id="menu-btn" style="width:30px;height:30px;border-radius:8px;background:none;border:none;cursor:pointer;color:rgba(255,255,255,.35);display:flex;align-items:center;justify-content:center;transition:color .18s;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <span style="font-family:'Cinzel',serif;font-size:1.22rem;font-weight:600;letter-spacing:.22em;background:linear-gradient(180deg,#fff 0%,#a8d8f0 40%,#5bb8e8 70%,#a0d4f5 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">PixAI</span>
    </div>
    <div style="display:flex;align-items:center;gap:.75rem;">
      <div id="brand-badge" style="display:none;align-items:center;gap:.38rem;padding:.2rem .65rem;background:rgba(0,194,255,.06);border:1px solid rgba(0,194,255,.18);border-radius:100px;">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="rgba(0,194,255,.55)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        <span id="brand-badge-name" style="font-size:.64rem;color:rgba(0,194,255,.72);letter-spacing:.06em;font-weight:500;"></span>
      </div>
      <!-- Usage counter -->
      <div id="usage-badge" style="display:flex;align-items:center;gap:.35rem;padding:.2rem .65rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:100px;">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        <span id="usage-text" style="font-size:.64rem;color:rgba(255,255,255,.35);letter-spacing:.04em;">30 left</span>
      </div>
      <button id="new-chat-btn" style="display:flex;align-items:center;gap:.38rem;padding:.32rem .78rem;background:rgba(0,194,255,.08);border:1px solid rgba(0,194,255,.2);border-radius:100px;font-size:.72rem;color:rgba(0,194,255,.8);cursor:pointer;transition:all .18s;letter-spacing:.04em;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> New chat
      </button>
      <!-- User avatar -->
      <div id="user-avatar" style="width:30px;height:30px;border-radius:50%;background:rgba(0,194,255,.1);border:1px solid rgba(0,194,255,.25);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:600;color:rgba(0,194,255,.8);cursor:pointer;flex-shrink:0;" title="Sign out"></div>
      <span class="hide-mobile" style="font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.13);">by Pixel IDEAS</span>
    </div>
  </header>

  <!-- Body -->
  <div style="flex:1;display:flex;overflow:hidden;">

    <!-- Sidebar -->
    <div id="sidebar" style="width:230px;flex-shrink:0;overflow:hidden;transition:width .28s cubic-bezier(.16,1,.3,1);border-right:1px solid rgba(255,255,255,.05);background:#080910;display:flex;flex-direction:column;">
      <div style="padding:.9rem .7rem .5rem;overflow-y:auto;flex:1;">
        <div style="font-size:.68rem;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.35);font-weight:700;padding:0 .4rem .6rem;margin-bottom:.4rem;border-bottom:1px solid rgba(255,255,255,.06);">My Journey</div>
        <div id="session-list"></div>
      </div>
    </div>

    <!-- Main -->
    <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
      <div id="chat-scroll" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;">

        <!-- Welcome -->
        <div id="welcome-screen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:2rem;animation:up .5s cubic-bezier(.16,1,.3,1) both;">
          <h1 style="line-height:1.1;margin-bottom:.55rem;">
            <span style="font-family:'Outfit',sans-serif;font-size:clamp(2.2rem,7vw,4rem);font-weight:300;letter-spacing:-.01em;color:rgba(255,255,255,.9);display:block;">Explore your</span>
            <span style="font-family:'Playfair Display',serif;font-size:clamp(2.6rem,8vw,4.8rem);font-weight:800;font-style:italic;letter-spacing:-.02em;background:linear-gradient(135deg,#fff 10%,rgba(120,200,255,.95) 50%,#00c2ff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:block;">Ideas!</span>
          </h1>
          <p style="font-size:.88rem;color:rgba(255,255,255,.24);margin-bottom:2.2rem;font-weight:300;letter-spacing:.03em;">Awake your Dreams into Real</p>
          <div style="display:flex;flex-wrap:wrap;gap:.48rem;justify-content:center;max-width:460px;">
            <button class="starter-btn" data-msg="What can you help me with?">What can you help me with?</button>
            <button class="starter-btn" data-msg="I have a rough startup idea">I have a rough startup idea</button>
            <button class="starter-btn" data-msg="Help me validate my idea">Help me validate my idea</button>
            <button class="starter-btn" data-msg="I don't know where to start">I don't know where to start</button>
          </div>
        </div>

        <!-- Messages -->
        <div id="messages-list" style="display:none;max-width:700px;width:100%;margin:0 auto;padding:2rem 1.5rem;flex-direction:column;"></div>

        <!-- Thinking -->
        <div id="thinking-row" style="display:none;max-width:700px;width:100%;margin:0 auto;padding:0 1.5rem;">
          <div style="display:flex;gap:.82rem;padding:1.15rem 0;">
            <div style="width:27px;height:27px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:3px;background:rgba(0,194,255,.08);border:1px solid rgba(0,194,255,.18);color:rgba(0,194,255,.7);">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            </div>
            <div style="flex:1;">
              <div style="font-size:.6rem;font-weight:600;letter-spacing:.15em;text-transform:uppercase;margin-bottom:.45rem;color:rgba(0,194,255,.42);">PixAI</div>
              <div style="display:flex;align-items:center;gap:.6rem;">
                <div style="display:flex;gap:4px;">
                  <span style="width:5px;height:5px;border-radius:50%;background:rgba(0,194,255,.45);display:inline-block;animation:dotbounce 1.4s ease-in-out 0s infinite;"></span>
                  <span style="width:5px;height:5px;border-radius:50%;background:rgba(0,194,255,.45);display:inline-block;animation:dotbounce 1.4s ease-in-out .18s infinite;"></span>
                  <span style="width:5px;height:5px;border-radius:50%;background:rgba(0,194,255,.45);display:inline-block;animation:dotbounce 1.4s ease-in-out .36s infinite;"></span>
                </div>
                <span id="thinking-status" style="font-size:.78rem;color:rgba(0,194,255,.5);font-style:italic;">Thinking...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Insights -->
        <div id="insight-panel" style="display:none;border-top:1px solid rgba(255,255,255,.055);padding:1.6rem 1.5rem 2.4rem;"></div>
        <div id="scroll-anchor" style="height:1px;"></div>
      </div>

      <!-- Input -->
      <div style="flex-shrink:0;padding:.82rem 1.4rem 1rem;border-top:1px solid rgba(255,255,255,.055);background:rgba(10,11,15,.98);">
        <div id="input-wrap" style="max-width:700px;margin:0 auto;background:#0f1116;border:1px solid rgba(255,255,255,.07);border-radius:15px;display:flex;align-items:flex-end;gap:.45rem;padding:.68rem .68rem .68rem 1.05rem;transition:border-color .2s,box-shadow .2s;">
          <textarea id="msg-input" rows="1" maxlength="2000" placeholder="Say anything..." style="flex:1;background:transparent;border:none;outline:none;color:rgba(255,255,255,.88);font-family:'Outfit',sans-serif;font-size:.94rem;line-height:1.65;resize:none;min-height:24px;max-height:180px;overflow-y:auto;"></textarea>
          <button id="send-btn" disabled style="width:33px;height:33px;border-radius:9px;flex-shrink:0;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);color:rgba(255,255,255,.14);cursor:not-allowed;display:flex;align-items:center;justify-content:center;transition:all .16s;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </button>
        </div>
        <p style="text-align:center;font-size:.62rem;color:rgba(255,255,255,.11);margin-top:.42rem;letter-spacing:.04em;">Enter to send Â· Shift+Enter for new line</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// â”€â”€ REPLACE WITH YOUR FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const DAILY_LIMIT = 30;
let currentUser = null;
let userMsgCount = 0;

// â”€â”€ Auth state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // Not logged in â€” redirect to your login page
    window.location.href = '/login.html';
    return;
  }
  currentUser = user;

  // Set avatar initials
  const initials = (user.displayName || user.email || 'U').slice(0, 2).toUpperCase();
  document.getElementById('user-avatar').textContent = initials;

  // Load/init usage from Firestore
  await loadUsage();

  // Hide loading screen
  document.getElementById('loading-screen').style.display = 'none';
});

// â”€â”€ Usage tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsage() {
  const ref = doc(db, 'usage', currentUser.uid);
  const snap = await getDoc(ref);
  const now = new Date();
  const todayStr = now.toISOString().slice(0, 10); // "2025-02-28"

  if (!snap.exists()) {
    // First time user
    await setDoc(ref, { count: 0, date: todayStr });
    userMsgCount = 0;
  } else {
    const data = snap.data();
    if (data.date !== todayStr) {
      // New day â€” reset
      await updateDoc(ref, { count: 0, date: todayStr });
      userMsgCount = 0;
    } else {
      userMsgCount = data.count || 0;
    }
  }
  updateUsageBadge();
}

async function incrementUsage() {
  userMsgCount++;
  const ref = doc(db, 'usage', currentUser.uid);
  await updateDoc(ref, { count: userMsgCount });
  updateUsageBadge();
}

function updateUsageBadge() {
  const remaining = Math.max(0, DAILY_LIMIT - userMsgCount);
  const el = document.getElementById('usage-text');
  const badge = document.getElementById('usage-badge');
  el.textContent = remaining + ' left';
  if (remaining <= 5) {
    el.style.color = '#f87171';
    badge.style.borderColor = 'rgba(248,113,113,.25)';
  } else if (remaining <= 10) {
    el.style.color = '#fbbf24';
    badge.style.borderColor = 'rgba(251,191,36,.2)';
  } else {
    el.style.color = 'rgba(255,255,255,.35)';
    badge.style.borderColor = 'rgba(255,255,255,.07)';
  }
}

function isLimitReached() {
  return userMsgCount >= DAILY_LIMIT;
}

// â”€â”€ Sign out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('user-avatar').addEventListener('click', async () => {
  if (confirm('Sign out of PixAI?')) {
    await signOut(auth);
    window.location.href = '/login.html';
  }
});

// â”€â”€ Countdown timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCountdown() {
  const now = new Date();
  const midnight = new Date();
  midnight.setHours(24, 0, 0, 0);
  const diff = midnight - now;
  const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
  const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
  const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
  const el = document.getElementById('countdown-timer');
  if (el) el.textContent = h + ':' + m + ':' + s;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// â”€â”€ Limit screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLimitScreen() {
  const ls = document.getElementById('limit-screen');
  ls.style.display = 'flex';
}
document.getElementById('close-limit-btn').addEventListener('click', () => {
  document.getElementById('limit-screen').style.display = 'none';
});
document.getElementById('upgrade-btn').addEventListener('click', () => {
  // Replace with your payment link when ready
  alert('Payment coming soon! For now, your free messages reset at midnight.');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ App Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const SVG_BOLT = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>';
const SVG_COPY = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
const SVG_CHECK = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="rgba(0,194,255,.8)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
const SVG_TRASH = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>';
const SVG_EDIT = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const SVG_CHAT = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>';

let sessions = [];
let activeId = null;
let messages = [];
let busy = false;
let brand = null;
let sidebarOpen = true;
let historyArr = [];
let thinkingInterval = null;
let thinkingStep = 0;

const THINKING_STEPS = ['Reading your idea...','Analysing the market...','Finding your audience...','Building the strategy...','Sharpening insights...'];
const BLOCKED_RESPONSES = [
  "Hey! That's not really what PixAI is about. Let's keep it focused on your startup ideas â€” what are you building? ðŸš€",
  "That's outside what I can help with here. PixAI is all about turning your ideas into real businesses. Got an idea you want to explore?",
  "Let's keep things on track! I'm here to help you build something amazing. What's your startup idea?",
  "That's not something I can dive into. But if you've got a business idea, I'd love to help you shape it! ðŸ’¡"
];
const BLOCKED_PATTERNS = [
  /\b(porn|nude|naked|nsfw|onlyfans|escort|hookup|erotic|hentai|xxx|fetish|masturbat|orgasm|penis|vagina|blowjob|handjob)\b/i,
  /\b(murder|shoot|stab|rape|bomb|cocaine|heroin|meth|trafficking)\b/i,
  /\b(nigger|faggot|chink|spic|kike)\b/i
];
const GREETING_TITLES = ['Intro','First Steps','Getting Started','New Beginning','Opening Move','Fresh Start','Day One','Starting Out','First Chat','Hello There'];

function loadStorage() { try { return JSON.parse(localStorage.getItem('pixai-sessions-' + (currentUser?.uid || '')) || '[]'); } catch (e) { return []; } }
function saveStorage() { try { localStorage.setItem('pixai-sessions-' + currentUser.uid, JSON.stringify(sessions)); } catch (e) {} }
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }
function escHtml(t) { return String(t || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function fmtText(text) {
  return text.split('\n').map(line => {
    if (!line.trim()) return '<div style="height:.15rem;"></div>';
    return '<div style="line-height:1.82;">' + line.split(/(\*\*[^*]+\*\*)/g).map(p =>
      (p.length > 4 && p.slice(0,2)==='**' && p.slice(-2)==='**')
        ? '<strong style="color:rgba(255,255,255,.93);font-weight:600;">' + escHtml(p.slice(2,-2)) + '</strong>'
        : escHtml(p)
    ).join('') + '</div>';
  }).join('');
}

function parseChips(raw) { const m = raw.match(/CHIPS:\s*(\[[\s\S]*?\])/); if (!m) return []; try { return JSON.parse(m[1]); } catch(e) { return []; } }
function stripChips(raw) { return raw.replace(/\nCHIPS:[\s\S]*$/, '').trim(); }
function isBlocked(t) { return BLOCKED_PATTERNS.some(p => p.test(t)); }
function blockedReply() { return BLOCKED_RESPONSES[Math.floor(Math.random() * BLOCKED_RESPONSES.length)]; }

function detectBrand(text) {
  const pats = [/(?:my (?:brand|startup|company|product|website|app)(?:\s+name)?\s+is\s*)["']?([A-Z][a-zA-Z0-9\s]{1,28})["']?/i, /["']([A-Z][a-zA-Z0-9]{2,24})["']\s+is\s+my/i];
  for (const r of pats) { const m = text.match(r); if (m) return m[1].trim(); }
  const camel = text.match(/\b([A-Z][a-z]+[A-Z][a-zA-Z]+)\b/);
  if (camel && /\b(my|our)\b/i.test(text)) return camel[1];
  return null;
}

function looksLikeIdea(t) {
  const text = t.toLowerCase();
  const kw = ['app','platform','service','product','startup','idea','build','create','launch','business','tool','software','website','marketplace','subscription','saas','ai','bot','system','solution','concept','plan','make','sell','offer','feature'];
  const words = text.split(/\s+/);
  if (words.length < 6) return false;
  return kw.some(k => text.includes(k)) || words.length > 20;
}

function scrollBottom() { requestAnimationFrame(() => { document.getElementById('scroll-anchor')?.scrollIntoView({ behavior:'smooth' }); }); }

function applySidebar() {
  const isMobile = window.innerWidth < 768;
  document.getElementById('sidebar').style.width = sidebarOpen ? (isMobile ? '260px' : '230px') : '0px';
  document.getElementById('sidebar-backdrop').style.display = (sidebarOpen && isMobile) ? 'block' : 'none';
}

function updateBrandBadge() {
  const badge = document.getElementById('brand-badge');
  const ta = document.getElementById('msg-input');
  if (brand) { badge.style.display = 'flex'; document.getElementById('brand-badge-name').textContent = brand.name; ta.placeholder = 'Ask about ' + brand.name + ' or share a new idea...'; }
  else { badge.style.display = 'none'; ta.placeholder = 'Say anything...'; }
}

function newChat() {
  const id = genId();
  sessions.unshift({ id, title:'New chat', messages:[], history:[], brand:null, ts:Date.now() });
  saveStorage();
  activeId = id; messages = []; historyArr = []; brand = null;
  updateBrandBadge(); renderSessions(); showWelcome();
  document.getElementById('insight-panel').style.display = 'none';
  document.getElementById('insight-panel').innerHTML = '';
  const ta = document.getElementById('msg-input');
  ta.value = ''; ta.style.height = 'auto'; refreshSendBtn();
  if (window.innerWidth < 768) { sidebarOpen = false; applySidebar(); }
}

function loadSession(s) {
  activeId = s.id; messages = (s.messages||[]).slice(); historyArr = (s.history||[]).slice(); brand = s.brand || null;
  updateBrandBadge();
  document.getElementById('insight-panel').style.display = 'none';
  document.getElementById('insight-panel').innerHTML = '';
  renderMessages(); renderSessions();
  if (window.innerWidth < 768) { sidebarOpen = false; applySidebar(); }
}

function deleteSession(id) {
  sessions = sessions.filter(s => s.id !== id); saveStorage();
  if (activeId === id) {
    if (sessions.length > 0) loadSession(sessions[0]);
    else { activeId = null; messages = []; historyArr = []; brand = null; updateBrandBadge(); showWelcome(); document.getElementById('insight-panel').style.display = 'none'; }
  }
  renderSessions();
}

function saveSession() {
  sessions = sessions.map(s => s.id === activeId ? { ...s, messages, history:historyArr, brand, ts:Date.now() } : s);
  saveStorage();
}

function groupSessions(list) {
  const now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate()), yesterday = new Date(today - 86400000);
  const g = { Today:[], Yesterday:[], Earlier:[] };
  list.forEach(s => { const d = new Date(s.ts); if (d >= today) g.Today.push(s); else if (d >= yesterday) g.Yesterday.push(s); else g.Earlier.push(s); });
  return g;
}

function renderSessions() {
  const el = document.getElementById('session-list');
  if (sessions.length === 0) { el.innerHTML = '<div style="padding:1.5rem .5rem;text-align:center;font-size:.72rem;color:rgba(255,255,255,.18);line-height:1.7;">No chats yet.<br/>Start a conversation!</div>'; return; }
  const g = groupSessions(sessions);
  const frag = document.createDocumentFragment();
  for (const label of ['Today','Yesterday','Earlier']) {
    const list = g[label]; if (!list.length) continue;
    const group = document.createElement('div'); group.style.cssText = 'margin-bottom:1rem;animation:sideIn .3s ease both;';
    const lbl = document.createElement('div'); lbl.style.cssText = 'font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.2);font-weight:600;padding:0 .4rem;margin-bottom:.35rem;'; lbl.textContent = label; group.appendChild(lbl);
    for (const s of list) {
      const isActive = s.id === activeId;
      const item = document.createElement('div'); item.className = 'session-item';
      item.style.cssText = 'display:flex;align-items:center;gap:.4rem;padding:.45rem .5rem;border-radius:9px;cursor:pointer;transition:all .15s;margin-bottom:.18rem;background:' + (isActive?'rgba(0,194,255,.08)':'transparent') + ';border:1px solid ' + (isActive?'rgba(0,194,255,.15)':'transparent') + ';';
      item.addEventListener('mouseenter', () => { if (activeId!==s.id) { item.style.background='rgba(255,255,255,.04)'; item.style.borderColor='rgba(255,255,255,.06)'; } });
      item.addEventListener('mouseleave', () => { if (activeId!==s.id) { item.style.background='transparent'; item.style.borderColor='transparent'; } });
      item.addEventListener('click', () => loadSession(s));
      const iconEl = document.createElement('span'); iconEl.style.cssText = 'color:' + (isActive?'rgba(0,194,255,.6)':'rgba(255,255,255,.22)') + ';flex-shrink:0;'; iconEl.innerHTML = SVG_CHAT;
      const titleSpan = document.createElement('span'); titleSpan.className = 'session-title'; titleSpan.style.cssText = 'font-size:.76rem;color:' + (isActive?'rgba(255,255,255,.82)':'rgba(255,255,255,.45)') + ';flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4;'; titleSpan.textContent = s.title;
      const actions = document.createElement('div'); actions.className = 'session-actions'; actions.style.cssText = 'display:flex;gap:2px;opacity:0;transition:opacity .15s;';
      const editBtn = document.createElement('button'); editBtn.style.cssText = 'background:none;border:none;cursor:pointer;color:rgba(255,255,255,.3);display:flex;padding:2px;border-radius:4px;'; editBtn.innerHTML = SVG_EDIT; editBtn.title = 'Rename';
      editBtn.addEventListener('mouseenter', () => editBtn.style.color='rgba(0,194,255,.8)'); editBtn.addEventListener('mouseleave', () => editBtn.style.color='rgba(255,255,255,.3)');
      editBtn.addEventListener('click', e => { e.stopPropagation(); startRename(item, s); });
      const delBtn = document.createElement('button'); delBtn.style.cssText = 'background:none;border:none;cursor:pointer;color:rgba(255,255,255,.3);display:flex;padding:2px;border-radius:4px;'; delBtn.innerHTML = SVG_TRASH; delBtn.title = 'Delete';
      delBtn.addEventListener('mouseenter', () => delBtn.style.color='#f87171'); delBtn.addEventListener('mouseleave', () => delBtn.style.color='rgba(255,255,255,.3)');
      delBtn.addEventListener('click', e => { e.stopPropagation(); deleteSession(s.id); });
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      item.appendChild(iconEl); item.appendChild(titleSpan); item.appendChild(actions);
      group.appendChild(item);
    }
    frag.appendChild(group);
  }
  el.innerHTML = ''; el.appendChild(frag);
}

function startRename(item, s) {
  const titleSpan = item.querySelector('.session-title');
  const input = document.createElement('input'); input.value = s.title;
  input.style.cssText = 'flex:1;background:rgba(0,194,255,.06);border:1px solid rgba(0,194,255,.3);border-radius:5px;padding:.15rem .4rem;font-size:.75rem;color:rgba(255,255,255,.9);outline:none;font-family:Outfit,sans-serif;min-width:0;width:100%;';
  const finish = () => { const t = input.value.trim()||s.title; sessions = sessions.map(ss => ss.id===s.id ? {...ss,title:t} : ss); saveStorage(); renderSessions(); };
  input.addEventListener('blur', finish); input.addEventListener('click', e => e.stopPropagation());
  input.addEventListener('keydown', e => { if (e.key==='Enter') { e.preventDefault(); finish(); } if (e.key==='Escape') renderSessions(); });
  titleSpan.replaceWith(input); input.focus();
}

function showWelcome() {
  document.getElementById('welcome-screen').style.display = 'flex';
  document.getElementById('messages-list').style.display = 'none';
  document.getElementById('thinking-row').style.display = 'none';
}

function renderMessages() {
  const ml = document.getElementById('messages-list'), ws = document.getElementById('welcome-screen');
  if (messages.length === 0) { showWelcome(); return; }
  ws.style.display = 'none'; ml.style.display = 'flex';
  const frag = document.createDocumentFragment();
  messages.forEach((m, idx) => {
    const row = document.createElement('div'); row.style.cssText = 'display:flex;gap:.82rem;padding:1.15rem 0;animation:up .28s cubic-bezier(.16,1,.3,1) both;';
    if (idx < messages.length - 1) row.style.borderBottom = '1px solid rgba(255,255,255,.055)';
    const avatar = document.createElement('div'); avatar.style.cssText = 'width:27px;height:27px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:3px;font-size:.6rem;font-weight:600;';
    if (m.role === 'user') { avatar.style.background='rgba(255,255,255,.05)'; avatar.style.border='1px solid rgba(255,255,255,.07)'; avatar.style.color='rgba(255,255,255,.22)'; avatar.textContent='You'; }
    else { avatar.style.background='rgba(0,194,255,.08)'; avatar.style.border='1px solid rgba(0,194,255,.18)'; avatar.style.color='rgba(0,194,255,.7)'; avatar.innerHTML=SVG_BOLT; }
    const body = document.createElement('div'); body.style.cssText = 'flex:1;min-width:0;';
    const labelEl = document.createElement('div'); labelEl.style.cssText = 'font-size:.6rem;font-weight:600;letter-spacing:.15em;text-transform:uppercase;margin-bottom:.4rem;color:' + (m.role==='user'?'rgba(255,255,255,.18)':'rgba(0,194,255,.42)') + ';'; labelEl.textContent = m.role==='user'?'You':'PixAI';
    const content = document.createElement('div'); content.id = 'msg-content-' + idx; content.style.cssText = 'font-size:.92rem;color:rgba(255,255,255,.76);line-height:1.82;';
    if (m.role === 'user') { content.style.whiteSpace='pre-wrap'; content.style.wordBreak='break-word'; content.textContent = m.text; }
    else { content.innerHTML = fmtText(m.text); }
    body.appendChild(labelEl); body.appendChild(content);
    if (m.role === 'ai' && m.chips?.length) {
      const cw = document.createElement('div'); cw.style.cssText = 'display:flex;flex-wrap:wrap;gap:.38rem;margin-top:.75rem;';
      m.chips.forEach(c => { const cb = document.createElement('button'); cb.className='chip-btn'; cb.textContent=c; cb.addEventListener('click', () => sendMessage(c)); cw.appendChild(cb); });
      body.appendChild(cw);
    }
    row.appendChild(avatar); row.appendChild(body); frag.appendChild(row);
  });
  ml.innerHTML = ''; ml.appendChild(frag); scrollBottom();
}

function refreshSendBtn() {
  const btn = document.getElementById('send-btn'), ta = document.getElementById('msg-input');
  const hasVal = ta.value.trim().length > 0 && !busy;
  btn.disabled = !hasVal;
  btn.style.background = hasVal ? 'rgba(0,194,255,.12)' : 'rgba(255,255,255,.03)';
  btn.style.borderColor = hasVal ? 'rgba(0,194,255,.25)' : 'rgba(255,255,255,.05)';
  btn.style.color = hasVal ? '#00c2ff' : 'rgba(255,255,255,.14)';
  btn.style.cursor = hasVal ? 'pointer' : 'not-allowed';
  const wrap = document.getElementById('input-wrap');
  wrap.style.borderColor = ta.value.trim() ? 'rgba(0,194,255,.22)' : 'rgba(255,255,255,.07)';
  wrap.style.boxShadow = ta.value.trim() ? '0 0 0 3px rgba(0,194,255,.04)' : 'none';
}

function startThinking(isIdea) {
  document.getElementById('thinking-row').style.display = 'block'; thinkingStep = 0;
  const statusEl = document.getElementById('thinking-status'); statusEl.textContent = isIdea ? THINKING_STEPS[0] : 'Thinking...';
  if (isIdea) { thinkingInterval = setInterval(() => { thinkingStep = (thinkingStep+1)%THINKING_STEPS.length; const el2=document.getElementById('thinking-status'); if(el2) el2.textContent=THINKING_STEPS[thinkingStep]; }, 1500); }
  scrollBottom();
}
function stopThinking() { clearInterval(thinkingInterval); document.getElementById('thinking-row').style.display = 'none'; }

function streamMessage(idx, fullText) {
  const el = document.getElementById('msg-content-' + idx); if (!el) return;
  let i = 0;
  function tick() {
    if (i < fullText.length) { i++; el.innerHTML = fmtText(fullText.slice(0,i)) + '<span style="display:inline-block;width:2px;height:1em;background:#00c2ff;margin-left:2px;vertical-align:text-bottom;border-radius:1px;animation:cur .85s step-end infinite;"></span>'; scrollBottom(); setTimeout(tick, 11+Math.random()*7); }
    else { el.innerHTML = fmtText(fullText); }
  }
  setTimeout(tick, 30);
}

function buildChatSystem(b) {
  const bc = b ? `\nBRAND CONTEXT:\n- User is the founder of "${b.name}"${b.description?' â€” '+b.description:''}.\n- You live inside their product. Engage as someone who genuinely knows this brand.\n- Never suggest renaming "${b.name}".\n` : '';
  return `You are PixAI â€” a premium AI startup mentor inside Pixel IDEAS, built for ambitious teenagers (ages 13-19).\nYou think and respond like a real founder who deeply understands ideas and genuinely roots for young builders.\n${bc}\nAUDIENCE: Teenagers who want to turn their ideas into real companies. Be encouraging, relatable, and inspiring.\n\nBEHAVIOR:\n- Greetings -> warm, 1-2 lines, ask what they're building.\n- Vague input -> ONE smart follow-up question only.\n- Real idea -> sharp mentor reaction. Validate or challenge. One key insight. Punchy.\n- Own brand mentioned -> genuine personal recognition.\n- Never generate structured reports in chat. No fluff. Plain text only.\n- If asked anything inappropriate, gently redirect back to startup ideas.\n\nEND every response with exactly this on a new line:\nCHIPS: ["chip1","chip2","chip3"]\n(3 specific follow-up prompts, max 5 words each, never generic)\n\nTONE: Confident, direct, warm. Like a cool older mentor who's actually built companies and believes in young founders.`;
}

function buildInsightSystem(b) {
  return `You are PixAI's insight engine. Return ONLY raw JSON â€” no markdown, no explanation.\n${b?`User's brand: "${b.name}"${b.description?' â€” '+b.description:''}. Use brandNames for sub-products/features.\n`:''} Be honest. Score fairly. Keep all text punchy and real.\n{"score":<integer 1-10>,"scoreVerdict":"<one punchy honest sentence>","refinedIdea":"<sharper version, 2 sentences>","audience":"<exact: age range, behaviour, platform, pain point>","brandNames":["Name1","Name2","Name3"],"hypeAngle":"<one bold specific viral tactic>","marketingPlan":"<platform + content type + cadence, 2 sentences>","launchSteps":"<step 1 -> step 2 -> step 3, practical>"}`;
}

async function callAPI(endpoint, body) {
  const res = await fetch('/api/' + endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return res.json();
}

async function generateTitle(userText, aiReply) {
  const greet = /^(hi|hello|hey|sup|yo|hiya|good morning|good evening|greetings)\b/i;
  if (greet.test(userText.trim())) return GREETING_TITLES[Math.floor(Math.random()*GREETING_TITLES.length)];
  try {
    const data = await callAPI('title', { userText, aiReply });
    return (data.content||[]).map(c=>c.text||'').join('').trim() || userText.slice(0,42);
  } catch(e) { return userText.slice(0,42); }
}

async function sendMessage(override) {
  const taEl = document.getElementById('msg-input');
  const text = (override !== undefined ? String(override) : taEl.value).trim();
  if (!text || busy) return;

  // Check limit BEFORE sending
  if (isLimitReached()) { showLimitScreen(); return; }

  if (!activeId) {
    const newId = genId();
    sessions.unshift({ id:newId, title:'New chat', messages:[], history:[], brand:null, ts:Date.now() });
    saveStorage(); activeId = newId; renderSessions();
  }

  taEl.value = ''; taEl.style.height = 'auto';
  document.getElementById('insight-panel').style.display = 'none';
  document.getElementById('insight-panel').innerHTML = '';

  const detected = detectBrand(text);
  if (detected && !brand) { brand = { name:detected }; updateBrandBadge(); }

  messages.push({ role:'user', text });
  historyArr.push({ role:'user', content:text });
  busy = true; refreshSendBtn(); renderMessages();
  const isIdea = looksLikeIdea(text);
  startThinking(isIdea);

  // Increment usage BEFORE API call (counts the attempt)
  await incrementUsage();

  if (isBlocked(text)) {
    messages.push({ role:'ai', text:blockedReply(), chips:['Tell me your startup idea','What problem do you solve?',"What's your target audience?"] });
    stopThinking(); busy=false; refreshSendBtn(); renderMessages(); saveSession(); renderSessions(); return;
  }

  try {
    const modData = await callAPI('moderate', { text });
    const isAiBlocked = (modData.content||[]).map(c=>c.text||'').join('').trim().toUpperCase().includes('BLOCK');
    if (isAiBlocked) {
      messages.push({ role:'ai', text:blockedReply(), chips:['Tell me your startup idea','What problem do you solve?',"What's your target audience?"] });
      stopThinking(); busy=false; refreshSendBtn(); renderMessages(); saveSession(); renderSessions(); return;
    }
  } catch(e) {}

  try {
    const chatData = await callAPI('chat', { messages:historyArr, system:buildChatSystem(brand) });
    const raw = (chatData.content||[]).map(c=>c.text||'').join('').trim();
    if (!raw) throw new Error('empty');
    const chips = parseChips(raw), clean = stripChips(raw);
    historyArr.push({ role:'assistant', content:clean });
    messages.push({ role:'ai', text:clean, chips });
    stopThinking(); busy=false; refreshSendBtn(); renderMessages();
    streamMessage(messages.length-1, clean);
    const sid = activeId, snap = sessions.find(s=>s.id===sid);
    if (snap && !snap.smartTitled) {
      generateTitle(text, clean).then(title => {
        sessions = sessions.map(s => s.id===sid ? {...s,title,smartTitled:true} : s);
        saveStorage(); renderSessions();
      });
    }
    saveSession();
  } catch(e) {
    messages.push({ role:'ai', text:'Something went wrong. Please try again.', chips:[] });
    stopThinking(); busy=false; refreshSendBtn(); renderMessages(); saveSession();
  }

  if (isIdea) {
    try {
      const insData = await callAPI('insights', { text, system:buildInsightSystem(brand) });
      const raw2 = (insData.content||[]).map(c=>c.text||'').join('').trim();
      const match = raw2.match(/\{[\s\S]*\}/);
      if (match) { const parsed = JSON.parse(match[0]); setTimeout(() => { renderInsightPanel(parsed); scrollBottom(); }, 750); }
    } catch(e) { console.warn('insight fail:', e); }
  }

  // Show limit screen if just hit the cap
  if (isLimitReached()) { setTimeout(showLimitScreen, 1500); }
}

function renderInsightPanel(d) {
  const panel = document.getElementById('insight-panel');
  const isWeak=d.score<=4, isAvg=d.score>=5&&d.score<=6, isStrong=d.score>=7;
  const col = d.score>=7?'#00c2ff':d.score>=5?'#fbbf24':'#f87171';
  const panelLabel = isWeak?'Idea Feedback':isAvg?'Idea Insights':'Full Breakdown';
  panel.innerHTML=''; panel.style.cssText='display:block;border-top:1px solid rgba(255,255,255,.055);padding:1.6rem 1.5rem 2.4rem;opacity:0;transform:translateY(12px);transition:all .45s ease;';
  const inner = document.createElement('div'); inner.style.cssText='max-width:700px;margin:0 auto;display:flex;flex-direction:column;gap:.58rem;';
  const hdr=document.createElement('div'); hdr.style.cssText='display:flex;align-items:center;justify-content:space-between;margin-bottom:.2rem;';
  const hdrLeft=document.createElement('div'); hdrLeft.style.cssText='display:flex;align-items:center;gap:.5rem;'; hdrLeft.innerHTML='<div style="width:3px;height:13px;border-radius:2px;background:#00c2ff;box-shadow:0 0 8px rgba(0,194,255,.55);"></div><span style="font-size:.59rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(0,194,255,.45);font-weight:600;">'+panelLabel+'</span>';
  const caBtn=document.createElement('button'); caBtn.style.cssText='display:flex;align-items:center;gap:.32rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:.25rem .65rem;font-size:.66rem;color:rgba(255,255,255,.26);cursor:pointer;letter-spacing:.04em;'; caBtn.innerHTML=SVG_COPY+' Copy all';
  caBtn.addEventListener('click', () => {
    let t='PixAI Breakdown'+(brand?' â€” '+brand.name:'')+'\n\nScore: '+d.score+'/10\n'+d.scoreVerdict+'\n\nRefined Idea:\n'+d.refinedIdea;
    if(isAvg||isStrong) t+='\n\nTarget Audience:\n'+d.audience;
    if(isStrong) t+='\n\nBrand Names: '+(d.brandNames||[]).join(', ')+'\n\nHype Angle:\n'+d.hypeAngle+'\n\nMarketing:\n'+d.marketingPlan+'\n\nLaunch Steps:\n'+d.launchSteps;
    navigator.clipboard?.writeText(t);
  });
  hdr.appendChild(hdrLeft); hdr.appendChild(caBtn); inner.appendChild(hdr);
  const scoreCard=makeCard(); const scoreRow=document.createElement('div'); scoreRow.style.cssText='display:flex;align-items:center;gap:1.1rem;';
  const ringEl=document.createElement('div'); ringEl.id='score-ring'; ringEl.style.cssText='position:relative;width:68px;height:68px;flex-shrink:0;';
  const scoreRight=document.createElement('div'); scoreRight.style.flex='1'; scoreRight.innerHTML='<div style="font-size:.57rem;letter-spacing:.15em;text-transform:uppercase;color:rgba(255,255,255,.22);margin-bottom:.28rem;">Idea Score</div><div style="font-size:.9rem;color:rgba(255,255,255,.74);line-height:1.6;">'+escHtml(d.scoreVerdict)+'</div>';
  scoreRow.appendChild(ringEl); scoreRow.appendChild(scoreRight); scoreCard.appendChild(scoreRow); inner.appendChild(scoreCard);
  inner.appendChild(makeInsightCard('Refined Idea', d.refinedIdea, d.refinedIdea));
  if(isAvg||isStrong) inner.appendChild(makeInsightCard('Target Audience', d.audience, d.audience));
  if(isStrong){
    const bnCard=makeCard(); bnCard.innerHTML='<div style="display:flex;align-items:center;gap:.42rem;margin-bottom:.5rem;"><div style="width:22px;height:22px;border-radius:7px;background:rgba(0,194,255,.06);border:1px solid rgba(0,194,255,.1);display:flex;align-items:center;justify-content:center;color:rgba(0,194,255,.6);"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></div><span style="font-size:.59rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.3);">'+(brand?'Names for '+escHtml(brand.name):'Brand Names')+'</span></div><div style="display:flex;flex-wrap:wrap;gap:.38rem;">'+(d.brandNames||[]).map(n=>'<span style="padding:.2rem .75rem;background:rgba(79,140,255,.07);border:1px solid rgba(79,140,255,.16);border-radius:100px;font-size:.84rem;color:rgba(255,255,255,.7);font-family:Cormorant Garamond,serif;font-weight:600;">'+escHtml(n)+'</span>').join('')+'</div>';
    inner.appendChild(bnCard);
    inner.appendChild(makeInsightCard('Hype Angle', d.hypeAngle, d.hypeAngle));
    const grid=document.createElement('div'); grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:.58rem;';
    grid.appendChild(makeInsightCard('Marketing Plan', d.marketingPlan, null));
    grid.appendChild(makeInsightCard('Launch Steps', d.launchSteps, null));
    inner.appendChild(grid);
  }
  panel.appendChild(inner);
  requestAnimationFrame(() => { panel.style.opacity='1'; panel.style.transform='translateY(0)'; });
  animateScoreRing('score-ring', d.score, col);
}

function makeCard() { const c=document.createElement('div'); c.style.cssText='background:#0f1116;border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:1.1rem 1.25rem;'; return c; }

function makeInsightCard(lbl, bodyText, copyVal) {
  const card=makeCard();
  const hdr=document.createElement('div'); hdr.style.cssText='display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;';
  const left=document.createElement('div'); left.style.cssText='display:flex;align-items:center;gap:.42rem;'; left.innerHTML='<div style="width:22px;height:22px;border-radius:7px;background:rgba(0,194,255,.06);border:1px solid rgba(0,194,255,.1);display:flex;align-items:center;justify-content:center;color:rgba(0,194,255,.6);"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div><span style="font-size:.59rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.3);">'+escHtml(lbl)+'</span>';
  hdr.appendChild(left);
  if(copyVal){ const cb=document.createElement('button'); cb.style.cssText='background:none;border:none;cursor:pointer;color:rgba(255,255,255,.15);padding:2px;display:flex;'; cb.innerHTML=SVG_COPY; cb.addEventListener('click',()=>{ navigator.clipboard?.writeText(copyVal); cb.innerHTML=SVG_CHECK; setTimeout(()=>cb.innerHTML=SVG_COPY,1800); }); hdr.appendChild(cb); }
  card.appendChild(hdr);
  const body=document.createElement('div'); body.style.cssText='font-size:.875rem;color:rgba(255,255,255,.68);line-height:1.82;'; body.textContent=bodyText||''; card.appendChild(body);
  return card;
}

function animateScoreRing(elId, score, col) {
  const el=document.getElementById(elId); if(!el) return;
  const r=26, circ=2*Math.PI*r;
  el.innerHTML='<svg width="68" height="68" style="transform:rotate(-90deg);"><circle cx="34" cy="34" r="'+r+'" fill="none" stroke="rgba(255,255,255,.05)" stroke-width="4"/><circle id="'+elId+'-arc" cx="34" cy="34" r="'+r+'" fill="none" stroke="'+col+'" stroke-width="4" stroke-dasharray="'+circ+'" stroke-dashoffset="'+circ+'" stroke-linecap="round" style="transition:stroke-dashoffset 1s cubic-bezier(.16,1,.3,1);"/></svg><div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;"><span id="'+elId+'-count" style="font-family:\'Cormorant Garamond\',serif;font-size:1.55rem;font-weight:700;line-height:1;color:'+col+';">0</span><span style="font-size:.5rem;color:rgba(255,255,255,.28);letter-spacing:.06em;">/10</span></div>';
  let n=0; const iv=setInterval(()=>{ n=Math.min(n+1,score); const ce=document.getElementById(elId+'-count'); if(ce) ce.textContent=String(n); if(n>=score){ clearInterval(iv); const arc=document.getElementById(elId+'-arc'); if(arc) arc.style.strokeDashoffset=String(circ-(score/10)*circ); } },65);
}

// â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('sidebar-backdrop').addEventListener('click', () => { if(window.innerWidth<768){sidebarOpen=false;applySidebar();} });
const menuBtn=document.getElementById('menu-btn'); menuBtn.addEventListener('click',()=>{sidebarOpen=!sidebarOpen;applySidebar();}); menuBtn.addEventListener('mouseenter',()=>menuBtn.style.color='rgba(255,255,255,.7)'); menuBtn.addEventListener('mouseleave',()=>menuBtn.style.color='rgba(255,255,255,.35)');
const ncBtn=document.getElementById('new-chat-btn'); ncBtn.addEventListener('click',newChat); ncBtn.addEventListener('mouseenter',()=>{ncBtn.style.background='rgba(0,194,255,.15)';ncBtn.style.borderColor='rgba(0,194,255,.4)';}); ncBtn.addEventListener('mouseleave',()=>{ncBtn.style.background='rgba(0,194,255,.08)';ncBtn.style.borderColor='rgba(0,194,255,.2)';});
document.querySelectorAll('.starter-btn').forEach(btn => btn.addEventListener('click', () => sendMessage(btn.getAttribute('data-msg'))));
const ta=document.getElementById('msg-input');
ta.addEventListener('input',()=>{ ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,180)+'px'; refreshSendBtn(); });
ta.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} });
document.getElementById('send-btn').addEventListener('click',()=>sendMessage());
window.addEventListener('resize',()=>{ if(window.innerWidth<768){sidebarOpen=false;applySidebar();} });

// Init sessions after auth is ready (auth listener calls loadStorage)
function initSessions() {
  sessions = loadStorage();
  renderSessions();
  if (sessions.length > 0) loadSession(sessions[0]);
  if (window.innerWidth < 768) { sidebarOpen = false; applySidebar(); }
}

// Called after Firebase auth resolves
window.__pixaiInit = initSessions;
</script>

<script>
// Trigger init after Firebase module loads and sets currentUser
const _origInit = window.__pixaiInit;
document.addEventListener('pixai-ready', () => { if (_origInit) _origInit(); });
</script>

</body>
</html>
